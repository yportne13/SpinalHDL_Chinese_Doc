<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>简单的实例 &mdash; SpinalHDL_Chinese 1.0.0 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/translations.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="进阶实例" href="%E8%BF%9B%E9%98%B6%E5%AE%9E%E4%BE%8B.html" />
    <link rel="prev" title="例子(Examples)" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> SpinalHDL_Chinese
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../%E5%85%B3%E4%BA%8ESpinalHDL/index.html">关于SpinalHDL(About SpinalHDL)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BC%80%E5%A7%8B%E5%85%A5%E9%97%A8/index.html">开始入门(Getting Started)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/index.html">数据类型(Data Types)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E7%BB%93%E6%9E%84/index.html">结构(Structuring)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E8%AF%AD%E4%B9%89/index.html">语义(Semantic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E6%97%B6%E5%BA%8F%E9%80%BB%E8%BE%91/index.html">时序逻辑(Sequential logic)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E8%AE%BE%E8%AE%A1%E9%94%99%E8%AF%AF/index.html">设计错误(Design Errors)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%85%B6%E5%AE%83%E8%AF%AD%E8%A8%80%E7%89%B9%E5%BE%81/index.html">其他语言特征(Other language features)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BA%93/index.html">Libraries(库)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E4%BB%BF%E7%9C%9F/index.html">仿真(Simulation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../%E5%BD%A2%E5%BC%8F%E9%AA%8C%E8%AF%81/index.html">形式验证(Formal verification)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">例子(Examples)</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">简单的实例</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#apb3">一、APB3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#carry-adder">二、进位加法器(Carry Adder)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#color-summing">三、颜色求和(Color Summing)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#counter-with-clear">四、带清除的计数器(Counter with clear)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pll-blackbox-and-reset-controller">五、锁相环黑盒与复位控制器(PLL BlackBox and reset controller)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rgb">六、RGB转灰度图</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rom-sinus-rom">七、正弦ROM(Sinus rom)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="%E8%BF%9B%E9%98%B6%E5%AE%9E%E4%BE%8B.html">进阶实例</a></li>
<li class="toctree-l2"><a class="reference internal" href="%E9%AB%98%E7%BA%A7%E5%AE%9E%E4%BE%8B.html">高级实例</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SpinalHDL_Chinese</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">例子(Examples)</a> &raquo;</li>
      <li>简单的实例</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/doc/例子/简单实例.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>简单的实例<a class="headerlink" href="#id1" title="此标题的永久链接"></a></h1>
<section id="apb3">
<h2>一、APB3<a class="headerlink" href="#apb3" title="此标题的永久链接"></a></h2>
<ol>
<li><p>简介</p>
<p>该例子将会展示定义APB3类的语句。</p>
</li>
<li><p>规范</p>
<p>ARM关于APB3的端口规范如下：</p>
</li>
</ol>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">信号名称</th>
<th style="text-align: center;">类型</th>
<th style="text-align: center;">驱动端</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">PADDR</td>
<td style="text-align: center;">UInt(位宽 bits)</td>
<td style="text-align: center;">Master</td>
<td style="text-align: center;">字节为单位的地址</td>
</tr>
<tr>
<td style="text-align: center;">PSEL</td>
<td style="text-align: center;">Bits(selWidth)</td>
<td style="text-align: center;">Master</td>
<td style="text-align: center;">每个从端1bit</td>
</tr>
<tr>
<td style="text-align: center;">PENABLE</td>
<td style="text-align: center;">Bool</td>
<td style="text-align: center;">Master</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">PWRITE</td>
<td style="text-align: center;">Bool</td>
<td style="text-align: center;">Master</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">PWDATA</td>
<td style="text-align: center;">Bits(dataWidth bits)</td>
<td style="text-align: center;">Master</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">PREADY</td>
<td style="text-align: center;">Bool</td>
<td style="text-align: center;">Slave</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">PRDATA</td>
<td style="text-align: center;">Bits(dataWidth bits)</td>
<td style="text-align: center;">Slave</td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td style="text-align: center;">PSLVERROR</td>
<td style="text-align: center;">Bool</td>
<td style="text-align: center;">Slave</td>
<td style="text-align: center;">可选</td>
</tr>
</tbody>
</table>
<ol>
<li>实现</li>
</ol><p>上述规范说明APB3总线有许多可能的配置。为了实现多样的配置，我们可以在Scala中定义一个配置类：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">selWidth</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>随后我们可以定义用来表示硬件总线的APB3类：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Apb3</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w"></span>

<span class="w">  </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">():</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="nc">PSEL</span><span class="p">,</span><span class="nc">PENABLE</span><span class="p">,</span><span class="nc">PWRITE</span><span class="p">,</span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<ol>
<li><p>应用(Usage)</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Apb3Config</span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="n">addressWidth</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">dataWidth</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">selWidth</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="w"></span>
<span class="p">)</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">apb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">Apb3</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">))</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PREADY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">apb</span><span class="p">.</span><span class="nc">PENABLE</span><span class="p">){</span><span class="w"></span>
<span class="w">  </span><span class="c1">//...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>上述代码比较简陋，个人编写了一个简单的APB3的Slave端总线挂一个寄存堆的代码，如下：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nc">Apb3</span>

<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span><span class="w">   </span><span class="c1">// 使用IMasterSlave需要调用lib库</span>

<span class="k">import</span><span class="w"> </span><span class="nn">scala</span><span class="p">.</span><span class="nn">math</span><span class="p">.</span><span class="n">_</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Apb3Slave</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">APB3Config</span><span class="p">(</span><span class="n">addressWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">dataWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">selWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">useSlaveError</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Boolean</span><span class="p">)</span><span class="w"> </span><span class="c1">// APB3总线的参数配置</span>


<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">APB3</span><span class="w"> </span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">APB3Config</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="nc">IMasterSlave</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PADDR</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSEL</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">selWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PENABLE</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PREADY</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWRITE</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bool</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PWDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PRDATA</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nc">Bits</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nc">PSLVERROR</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="kc">null</span><span class="w">   </span><span class="c1">// 只有当配置中的useSlaveError为真时才生成该端口</span>

<span class="w">    </span><span class="k">override</span><span class="w"> </span><span class="k">def</span><span class="w"> </span><span class="nf">asMaster</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">      </span><span class="n">out</span><span class="p">(</span><span class="nc">PADDR</span><span class="p">,</span><span class="nc">PSEL</span><span class="p">,</span><span class="nc">PENABLE</span><span class="p">,</span><span class="nc">PWRITE</span><span class="p">,</span><span class="nc">PWDATA</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">in</span><span class="p">(</span><span class="nc">PREADY</span><span class="p">,</span><span class="nc">PRDATA</span><span class="p">)</span><span class="w"></span>

<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">useSlaveError</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">(</span><span class="nc">PSLVERROR</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="c1">// 使用asMaster的好处在于，asSlave直接就默认是Master端口的反面</span>



<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">apbConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">APB3Config</span><span class="p">(</span><span class="n">addressWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="n">dataWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="n">selWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">useSlaveError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="c1">// 用户配置参数</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">slaveBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slave</span><span class="p">(</span><span class="nc">APB3</span><span class="p">(</span><span class="n">apbConfig</span><span class="p">))</span><span class="w"> </span><span class="c1">// 定义总线的slave端</span>
<span class="w">    </span><span class="c1">//val masterBus = master(APB3(apbConfig))// 定义总线的master端，不知道为何，用asMater定义，无法使用io.masterBus.PADDR表述</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>


<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PREADY</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">num</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">addressWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">mem</span><span class="w">        </span><span class="o">=</span><span class="w"> </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">Bits</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">dataWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="w"> </span><span class="n">num</span><span class="p">.</span><span class="n">toInt</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">mem</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">enable</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PWRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PADDR</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">data</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PWDATA</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PRDATA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">enable</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PSEL</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PENABLE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">slaveBus</span><span class="p">.</span><span class="nc">PADDR</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="p">}</span><span class="w"></span>
<span class="k">object</span><span class="w"> </span><span class="nc">Apb3SlaveInst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">Apb3Slave</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>生成的Verilog代码为：</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : Apb3Slave</span>
<span class="k">module</span><span class="w"> </span><span class="n">Apb3Slave</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_slaveBus_PADDR</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_slaveBus_PSEL</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_slaveBus_PENABLE</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">io_slaveBus_PREADY</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_slaveBus_PWRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_slaveBus_PWDATA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_slaveBus_PRDATA</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_mem_port1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_mem_port</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_io_slaveBus_PRDATA</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">15</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_mem_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_slaveBus_PSEL</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io_slaveBus_PWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">_zz_mem_port</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">mem</span><span class="p">[</span><span class="n">io_slaveBus_PADDR</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_slaveBus_PWDATA</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">_zz_io_slaveBus_PRDATA</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">_zz_mem_port1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">mem</span><span class="p">[</span><span class="n">io_slaveBus_PADDR</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_slaveBus_PREADY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_io_slaveBus_PRDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_slaveBus_PSEL</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">io_slaveBus_PENABLE</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_slaveBus_PRDATA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_mem_port1</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="carry-adder">
<h2>二、进位加法器(Carry Adder)<a class="headerlink" href="#carry-adder" title="此标题的永久链接"></a></h2>
<p>该示例定义了一个具有输入<code class="docutils literal notranslate"><span class="pre">a</span></code>和<code class="docutils literal notranslate"><span class="pre">b</span></code>以及<code class="docutils literal notranslate"><span class="pre">result</span></code>输出的组件。在任何时候，结果都是<code class="docutils literal notranslate"><span class="pre">a</span></code>和<code class="docutils literal notranslate"><span class="pre">b</span></code>(组合逻辑)的和。这个求和是由进位加法器完成的。</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CarryAdder</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w">      </span><span class="c1">//result = a + b</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">False</span><span class="w">                   </span><span class="c1">//Carry, like a VHDL variable</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//Create some intermediate value in the loop scope.</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="c1">//The carry adder&#39;s asynchronous logic</span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">^</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="w">    </span><span class="n">c</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="n">&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w">    </span><span class="c1">//variable assignment</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">object</span><span class="w"> </span><span class="nc">CarryAdderProject</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVhdl</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">CarryAdder</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>会生成如下代码:</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : CarryAdder</span>



<span class="k">module</span><span class="w"> </span><span class="n">CarryAdder</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_a</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_result</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">c_4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">c_3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">c_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">c_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_1_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_2_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_3_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_c_4_1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">c_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_3</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">_zz_c_4</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_zz_c_4_1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_4</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_3</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_4_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_3</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">c_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">_zz_c_3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_zz_c_3_1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_3</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_2</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_3_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_2</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">c_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">_zz_c_2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_zz_c_2_1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_2</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_1</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_2_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c_1</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">c_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">c_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(((</span><span class="n">_zz_c_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">_zz_c_1_1</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_c_1_1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_1_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">io_result</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">_zz_c_1</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">_zz_c_1_1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_result</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">_zz_c_2</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">_zz_c_2_1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">c_1</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_result</span><span class="p">[</span><span class="mh">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">_zz_c_3</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">_zz_c_3_1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">c_2</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">io_result</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">_zz_c_4</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">_zz_c_4_1</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="n">c_3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_2_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">2</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_3_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">2</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_a</span><span class="p">[</span><span class="mh">3</span><span class="p">];</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_c_4_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io_b</span><span class="p">[</span><span class="mh">3</span><span class="p">];</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="color-summing">
<h2>三、颜色求和(Color Summing)<a class="headerlink" href="#color-summing" title="此标题的永久链接"></a></h2>
<p>首先，定义一个带有加法的Color <code class="docutils literal notranslate"><span class="pre">Bundle</span></code>。</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">+</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Color</span><span class="p">):</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">r</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">g</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">():</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>然后，定义一个带<code class="docutils literal notranslate"><span class="pre">source</span></code>输入(颜色向量)和输出<code class="docutils literal notranslate"><span class="pre">result</span></code>(<code class="docutils literal notranslate"><span class="pre">source</span></code>输入之和)的组件。</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ColorSumming</span><span class="p">(</span><span class="n">sourceCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">),</span><span class="w"> </span><span class="n">sourceCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">sum</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sourceCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">sources</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>总的SpinalHDL代码为：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">package</span><span class="w"> </span><span class="nc">ColorSumming</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
<span class="k">case</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">channelWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">+</span><span class="p">(</span><span class="n">that</span><span class="p">:</span><span class="w"> </span><span class="nc">Color</span><span class="p">):</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">r</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">g</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">that</span><span class="p">.</span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">():</span><span class="w"> </span><span class="nc">Color</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="bp">this</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">class</span><span class="w"> </span><span class="nc">ColorSumming</span><span class="p">(</span><span class="n">sourceCount</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="w"> </span><span class="n">channelWidth</span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Vec</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">),</span><span class="w"> </span><span class="n">sourceCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="p">(</span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Color</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">sum</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">sourceCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">\=</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">sources</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">sum</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="k">object</span><span class="w"> </span><span class="nc">ColorSummingInst</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="nc">Array</span><span class="p">[</span><span class="nc">String</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nc">SpinalVerilog</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="nc">ColorSumming</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>生成的Verilog代码为：</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : ColorSumming</span>
<span class="k">module</span><span class="w"> </span><span class="n">ColorSumming</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_0_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_0_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_0_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_1_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_1_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_1_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_2_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_2_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_sources_2_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_result_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_result_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_result_b</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_g</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_r_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_g_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_b_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_r_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_g_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_io_result_b_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">sum_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">sum_g</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">sum_b</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_r_1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_r_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_2_r</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_g_1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_g_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_2_g</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_b_1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_b_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_2_b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_r_2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_r_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_1_r</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_g_2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_g_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_1_g</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_b_2</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_io_result_b_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_1_b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum_r</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_r_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sum_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_0_r</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum_g</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_g_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sum_g</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_0_g</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum_b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">_zz_io_result_b_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sum_b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">io_sources_0_b</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sum_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sum_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">sum_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_result_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_r</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_result_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_g</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_result_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_result_b</span><span class="p">;</span><span class="w"></span>

<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="counter-with-clear">
<h2>四、带清除的计数器(Counter with clear)<a class="headerlink" href="#counter-with-clear" title="此标题的永久链接"></a></h2>
<p>本例定义了一个具有<code class="docutils literal notranslate"><span class="pre">clear</span></code>输入和<code class="docutils literal notranslate"><span class="pre">value</span></code>输出的组件。每个时钟周期输出的<code class="docutils literal notranslate"><span class="pre">value</span></code>都是递增的，但是当<code class="docutils literal notranslate"><span class="pre">clear</span></code>值很高时，<code class="docutils literal notranslate"><span class="pre">value</span></code>被清除。</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Counter</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">width</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">register</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">register</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">register</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">register</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="pll-blackbox-and-reset-controller">
<h2>五、锁相环黑盒与复位控制器(PLL BlackBox and reset controller)<a class="headerlink" href="#pll-blackbox-and-reset-controller" title="此标题的永久链接"></a></h2>
<p>假设用户需要定义一个<code class="docutils literal notranslate"><span class="pre">TopLevel</span></code>组件来例化一个PLL<code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>，并且利用它建立一个新的时钟域应用到设计中。同时用户可能需要将外部的异步复位逻辑应用到该时钟域中，与一个同步复位资源连接。</p>
<p>本小章中需要导入如下库：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">core</span><span class="p">.</span><span class="n">_</span>
<span class="k">import</span><span class="w"> </span><span class="nn">spinal</span><span class="p">.</span><span class="nn">lib</span><span class="p">.</span><span class="n">_</span>
</pre></div>
</div>
<ol>
<li><p>锁相环黑盒定义(The PLL BlackBox definition)</p>
<p>下述代码展示了如何定义锁相环<code class="docutils literal notranslate"><span class="pre">BlackBox</span></code>：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PLL</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">BlackBox</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkIn</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clkOut</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">isLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="n">noIoPrefix</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>其会生成如下VHDL代码：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="n">component</span><span class="w"> </span><span class="nc">PLL</span><span class="w"> </span><span class="n">is</span><span class="w"></span>
<span class="w">  </span><span class="n">port</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">clkIn</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">clkOut</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">std_logic</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">isLocked</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">std_logic</span><span class="w"></span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="n">end</span><span class="w"> </span><span class="n">component</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>顶层定义(TopLevel definition)</p>
<p>下述例子展示了如何定义个人的<code class="docutils literal notranslate"><span class="pre">TopLevel</span></code>来例化锁相环，建立新<code class="docutils literal notranslate"><span class="pre">clockdomain</span></code>并且将异步复位的输入连接至同步复位端口：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">aReset</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clk100Mhz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">result</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">// 创建一个Area来管理所有时钟和复位</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">clkCtrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Area</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">//例化并驱动PLL</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">pll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">PLL</span><span class="w"></span>
<span class="w">    </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clkIn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">clk100Mhz</span><span class="w"></span>

<span class="w">    </span><span class="c1">//建立新时钟域&#39;core&#39;</span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ClockDomain</span><span class="p">.</span><span class="n">internal</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;core&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">frequency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">FixedFrequency</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="nc">MHz</span><span class="p">)</span><span class="w">  </span><span class="c1">// 该频率要求可以被使用</span>
<span class="w">    </span><span class="p">)</span><span class="w">                                      </span><span class="c1">// 通过coreClockDomain用户来做某些计算</span>

<span class="w">    </span><span class="c1">//驱动coreClockDomain的时钟和复位</span>
<span class="w">    </span><span class="n">coreClockDomain</span><span class="p">.</span><span class="n">clock</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">clkOut</span><span class="w"></span>
<span class="w">    </span><span class="n">coreClockDomain</span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">ResetCtrl</span><span class="p">.</span><span class="n">asyncAssertSyncDeassert</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span><span class="p">.</span><span class="n">aReset</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">pll</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">isLocked</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">clockDomain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">coreClockDomain</span><span class="w"></span>
<span class="w">    </span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="c1">//建立clkCtrl.coreClockDomain下的ClockingArea</span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">ClockingArea</span><span class="p">(</span><span class="n">clkCtrl</span><span class="p">.</span><span class="n">coreClockDomain</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">counter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">counter</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>会生成如下Verilog代码：</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : MyTopLevel</span>
<span class="k">module</span><span class="w"> </span><span class="n">MyTopLevel</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_aReset</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_clk100Mhz</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_result</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">clkCtrl_pll_clkOut</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">clkCtrl_pll_isLocked</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">bufferCC_1_io_dataOut</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">core_clk</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">core_reset</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">core_counter</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="n">PLL</span><span class="w"> </span><span class="n">clkCtrl_pll</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">clkIn</span><span class="w">       </span><span class="p">(</span><span class="n">io_clk100Mhz</span><span class="w">          </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">clkOut</span><span class="w">      </span><span class="p">(</span><span class="n">clkCtrl_pll_clkOut</span><span class="w">    </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">isLocked</span><span class="w">    </span><span class="p">(</span><span class="n">clkCtrl_pll_isLocked</span><span class="w">  </span><span class="p">)</span><span class="w">  </span><span class="c1">//o</span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="n">BufferCC</span><span class="w"> </span><span class="n">bufferCC_1</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">io_dataIn</span><span class="w">     </span><span class="p">(</span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="w">                   </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">io_dataOut</span><span class="w">    </span><span class="p">(</span><span class="n">bufferCC_1_io_dataOut</span><span class="w">  </span><span class="p">),</span><span class="w"> </span><span class="c1">//o</span>
<span class="w">    </span><span class="p">.</span><span class="n">core_clk</span><span class="w">      </span><span class="p">(</span><span class="n">core_clk</span><span class="w">               </span><span class="p">),</span><span class="w"> </span><span class="c1">//i</span>
<span class="w">    </span><span class="p">.</span><span class="n">_zz_1</span><span class="w">         </span><span class="p">(</span><span class="n">_zz_1</span><span class="w">                  </span><span class="p">)</span><span class="w">  </span><span class="c1">//i</span>
<span class="w">  </span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">core_clk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clkCtrl_pll_clkOut</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_aReset</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="w"> </span><span class="n">clkCtrl_pll_isLocked</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">core_reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bufferCC_1_io_dataOut</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core_counter</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">core_clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">core_reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">core_reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">core_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0000</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">core_counter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">core_counter</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">4</span><span class="mb">&#39;b0001</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>


<span class="k">endmodule</span><span class="w"></span>

<span class="k">module</span><span class="w"> </span><span class="n">BufferCC</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_dataIn</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">              </span><span class="n">io_dataOut</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">core_clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">_zz_1</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">async_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kt">reg</span><span class="w">                 </span><span class="n">buffers_0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">(</span><span class="o">*</span><span class="w"> </span><span class="n">async_reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="kt">reg</span><span class="w">                 </span><span class="n">buffers_1</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_dataOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffers_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">core_clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">_zz_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">_zz_1</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">buffers_0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">buffers_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">buffers_0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">io_dataIn</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">buffers_1</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">buffers_0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>


<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="rgb">
<h2>六、RGB转灰度图<a class="headerlink" href="#rgb" title="此标题的永久链接"></a></h2>
<p>假设要建立一个可以将RGB图转化成灰度图并存到外部Memory的组件。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">IO名称</th>
<th style="text-align: center;">方向</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">clear</td>
<td style="text-align: center;">in</td>
<td style="text-align: center;">清除所有内部寄存器</td>
</tr>
<tr>
<td style="text-align: center;">r,g,b</td>
<td style="text-align: center;">in</td>
<td style="text-align: center;">颜色输入</td>
</tr>
<tr>
<td style="text-align: center;">wr</td>
<td style="text-align: center;">out</td>
<td style="text-align: center;">写存储</td>
</tr>
<tr>
<td style="text-align: center;">address</td>
<td style="text-align: center;">out</td>
<td style="text-align: center;">存储地址，每周期增加</td>
</tr>
<tr>
<td style="text-align: center;">data</td>
<td style="text-align: center;">out</td>
<td style="text-align: center;">存储数据，灰度等级</td>
</tr>
</tbody>
</table><div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RgbToGray</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">clear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>

<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">Bool</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">16</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">UInt</span><span class="p">(</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">coef</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="p">,</span><span class="n">by</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Float</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">UInt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">U</span><span class="p">((</span><span class="mi">255</span><span class="o">*</span><span class="n">by</span><span class="p">).</span><span class="n">toInt</span><span class="p">,</span><span class="mi">8</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">gray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="n">coef</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">r</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">coef</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">g</span><span class="p">,</span><span class="mf">0.4f</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<span class="w">    </span><span class="n">coef</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="mf">0.3f</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">)</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">CounterFreeRun</span><span class="p">(</span><span class="n">stateCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">address</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">address</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">True</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">gray</span><span class="w"></span>

<span class="w">  </span><span class="n">when</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">clear</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="n">gray</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">address</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="n">io</span><span class="p">.</span><span class="n">wr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">False</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>生成的Verilog如下：</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : RgbToGray</span>
<span class="k">module</span><span class="w"> </span><span class="n">RgbToGray</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">io_clear</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_r</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_g</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">      </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_b</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w"> </span><span class="kt">reg</span><span class="w">          </span><span class="n">io_wr</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_address</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">io_data</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_gray</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_gray_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_gray_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_gray_3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_gray_4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_gray_5</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_gray_6</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_address_valueNext</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">_zz_address_valueNext_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">7</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">gray</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">address_willIncrement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">                 </span><span class="n">address_willClear</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">address_valueNext</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">address_value</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">address_willOverflowIfInc</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">address_willOverflow</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_gray_1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_zz_gray_3</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_gray_2</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mh">8</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_r</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">8&#39;h4c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_gray_4</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mh">8</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_g</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">8&#39;h66</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_gray_6</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mh">8</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_gray_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_b</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">8&#39;h4c</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_address_valueNext_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address_willIncrement</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_address_valueNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">15</span><span class="mi">&#39;d0</span><span class="p">,</span><span class="w"> </span><span class="n">_zz_address_valueNext_1</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">address_willClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">io_clear</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">address_willClear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">address_willOverflowIfInc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address_value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">16&#39;hffff</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">address_willOverflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address_willOverflowIfInc</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">address_willIncrement</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">address_valueNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">address_value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_zz_address_valueNext</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">address_willClear</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">address_valueNext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">16&#39;h0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">address_willIncrement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address_value</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">io_wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">io_clear</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">io_wr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gray</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="n">gray</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">_zz_gray</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">_zz_gray_5</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">io_clear</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">gray</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">8&#39;h0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">address_value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16&#39;h0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">address_value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">address_valueNext</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>


<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="rom-sinus-rom">
<h2>七、正弦ROM(Sinus rom)<a class="headerlink" href="#rom-sinus-rom" title="此标题的永久链接"></a></h2>
<p>假设用户需要生成一个正弦波以及其滤波后的形式。</p>
<table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">参数名称</th>
<th style="text-align: center;">类型</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">resolutionWidth</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">表述数值的比特位宽</td>
</tr>
<tr>
<td style="text-align: center;">sampleCount</td>
<td style="text-align: center;">Int</td>
<td style="text-align: center;">一个正弦周期的采样点数</td>
</tr>
</tbody>
</table><table border="1" class="docutils">
<thead>
<tr>
<th style="text-align: center;">IO名称</th>
<th style="text-align: center;">方向</th>
<th style="text-align: center;">类型</th>
<th style="text-align: center;">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">sin</td>
<td style="text-align: center;">out</td>
<td style="text-align: center;">SInt(resolutionWidth bits)</td>
<td style="text-align: center;">描述正弦波的输出</td>
</tr>
<tr>
<td style="text-align: center;">sinFiltred</td>
<td style="text-align: center;">out</td>
<td style="text-align: center;">SInt(resolutionWidth bits)</td>
<td style="text-align: center;">描述滤波后正弦波的输出</td>
</tr>
</tbody>
</table><p>定义一个<code class="docutils literal notranslate"><span class="pre">Component</span></code></p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="n">sampleCount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinFiltred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="c1">// 这里写逻辑实现</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>为了在<code class="docutils literal notranslate"><span class="pre">sin</span></code>输出端口输出正弦波，需要定义一个包含了正弦波一个周期内所有采样点的ROM。随后可以利用相位计数器读取ROM并生成正弦波。</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="c1">//定义生成ROM的函数</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sinTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">sinValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nc">S</span><span class="p">((</span><span class="n">sinValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">resolutionWidth</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">toInt</span><span class="p">,</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="n">initialContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinTable</span><span class="p">)</span><span class="w"></span>
<span class="kd">val</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="n">phase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>随后生成<code class="docutils literal notranslate"><span class="pre">sinFiltered</span></code>，例如可以使用一个一阶低通滤波器：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>完整代码如下：</p>
<div class="highlight-Scala notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TopLevel</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">,</span><span class="n">sampleCount</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Int</span><span class="p">)</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nc">Component</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="nc">Bundle</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinFiltred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">sinTable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">for</span><span class="p">(</span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">until</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="k">yield</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="n">sinValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nc">Math</span><span class="p">.</span><span class="nc">PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sampleIndex</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sampleCount</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="nc">S</span><span class="p">((</span><span class="n">sinValue</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">resolutionWidth</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">toInt</span><span class="p">,</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="nc">Mem</span><span class="p">(</span><span class="nc">SInt</span><span class="p">(</span><span class="n">resolutionWidth</span><span class="w"> </span><span class="n">bits</span><span class="p">),</span><span class="n">initialContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sinTable</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="kd">val</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Reg</span><span class="p">(</span><span class="nc">UInt</span><span class="p">(</span><span class="n">log2Up</span><span class="p">(</span><span class="n">sampleCount</span><span class="p">)</span><span class="w"> </span><span class="n">bits</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">phase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>

<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">rom</span><span class="p">.</span><span class="n">readSync</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nc">RegNext</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sinFiltred</span><span class="w">  </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">sin</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>设置位宽为16，采样数为32，生成的Verilog为：</p>
<div class="highlight-Verilog notranslate"><div class="highlight"><pre><span></span><span class="c1">// Generator : SpinalHDL v1.6.0    git head : 73c8d8e2b86b45646e9d0b2e729291f2b65e6be3</span>
<span class="c1">// Component : MyTopLevel</span>



<span class="k">module</span><span class="w"> </span><span class="n">MyTopLevel</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_sin</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">output</span><span class="w">     </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">io_sinFiltred</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">clk</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">input</span><span class="w">               </span><span class="n">reset</span><span class="w"></span>
<span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_rom_port0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_rom_port</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">                </span><span class="n">_zz_io_sin</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz__zz_io_sinFiltred</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz__zz_io_sinFiltred_1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">10</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz__zz_io_sinFiltred_2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz__zz_io_sinFiltred_3</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">wire</span><span class="w">       </span><span class="p">[</span><span class="mh">10</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz__zz_io_sinFiltred_4</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">    </span><span class="n">phase</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w">        </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w">   </span><span class="n">_zz_io_sinFiltred</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kt">reg</span><span class="w"> </span><span class="p">[</span><span class="mh">15</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span><span class="w"> </span><span class="n">rom</span><span class="w"> </span><span class="p">[</span><span class="mh">0</span><span class="o">:</span><span class="mh">31</span><span class="p">];</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">io_sinFiltred</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">_zz__zz_io_sinFiltred_1</span><span class="p">));</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_sinFiltred</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mh">5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">5</span><span class="p">{</span><span class="n">_zz__zz_io_sinFiltred_2</span><span class="p">[</span><span class="mh">10</span><span class="p">]}},</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_2</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">io_sin</span><span class="w"> </span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="mh">5</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="mh">5</span><span class="p">{</span><span class="n">_zz__zz_io_sinFiltred_4</span><span class="p">[</span><span class="mh">10</span><span class="p">]}},</span><span class="w"> </span><span class="n">_zz__zz_io_sinFiltred_4</span><span class="p">};</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">_zz_io_sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">initial</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="nb">$readmemb</span><span class="p">(</span><span class="s">&quot;MyTopLevel.v_toplevel_rom.bin&quot;</span><span class="p">,</span><span class="n">rom</span><span class="p">);</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">_zz_io_sin</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">_zz_rom_port0</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">rom</span><span class="p">[</span><span class="n">phase</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>

<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_sin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_rom_port0</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">assign</span><span class="w"> </span><span class="n">io_sinFiltred</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_zz_io_sinFiltred</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="k">always</span><span class="w"> </span><span class="p">@(</span><span class="k">posedge</span><span class="w"> </span><span class="n">clk</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="k">posedge</span><span class="w"> </span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">phase</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">5&#39;h0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">_zz_io_sinFiltred</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mh">16&#39;h0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span><span class="w"></span>
<span class="w">      </span><span class="n">phase</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">phase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">5&#39;h01</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">_zz_io_sinFiltred</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="p">(</span><span class="n">$signed</span><span class="p">(</span><span class="n">_zz__zz_io_sinFiltred</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">$signed</span><span class="p">(</span><span class="n">_zz__zz_io_sinFiltred_3</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">end</span><span class="w"></span>
<span class="w">  </span><span class="k">end</span><span class="w"></span>


<span class="k">endmodule</span><span class="w"></span>
</pre></div>
</div>
<p>其中ROM的Binary文件为：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0000000000000000</span>
<span class="mi">0001100011111000</span>
<span class="mi">0011000011111011</span>
<span class="mi">0100011100011100</span>
<span class="mi">0101101010000001</span>
<span class="mi">0110101001101100</span>
<span class="mi">0111011001000000</span>
<span class="mi">0111110110001001</span>
<span class="mi">0111111111111111</span>
<span class="mi">0111110110001001</span>
<span class="mi">0111011001000000</span>
<span class="mi">0110101001101100</span>
<span class="mi">0101101010000001</span>
<span class="mi">0100011100011100</span>
<span class="mi">0011000011111011</span>
<span class="mi">0001100011111000</span>
<span class="mi">0000000000000000</span>
<span class="mi">1110011100001000</span>
<span class="mi">1100111100000101</span>
<span class="mi">1011100011100100</span>
<span class="mi">1010010101111111</span>
<span class="mi">1001010110010100</span>
<span class="mi">1000100111000000</span>
<span class="mi">1000001001110111</span>
<span class="mi">1000000000000001</span>
<span class="mi">1000001001110111</span>
<span class="mi">1000100111000000</span>
<span class="mi">1001010110010100</span>
<span class="mi">1010010101111111</span>
<span class="mi">1011100011100100</span>
<span class="mi">1100111100000101</span>
<span class="mi">1110011100001000</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="例子(Examples)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="%E8%BF%9B%E9%98%B6%E5%AE%9E%E4%BE%8B.html" class="btn btn-neutral float-right" title="进阶实例" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2022, THU-CGRA.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>